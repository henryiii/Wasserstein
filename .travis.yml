language: python

install: pip3 install --upgrade numpy pytest cibuildwheel twine

script:
  - python3 setup.py install
  - pytest wasserstein

stages:
  - test
  - build

jobs:
  include:

    # test on linux
    - name: Test Python3.7 on Linux
      stage: test
      dist: bionic
      python: 3.7

    # test on linux
    - name: Test Python3.8 on Linux
      stage: test
      dist: bionic
      python: 3.8

    # test on Mac
    - name: Test on Mac
      stage: test
      os: mac
      osx_image: xcode12
      language: shell
      before_install: |
        brew update > /dev/null
        brew upgrade python boost
        brew install libomp

    # test on Windows
    - name: Test on Windows
      stage: test
      os: windows
      language: shell
      before_install: 
        - choco install python --version 3.8.0
        - ln -s /c/Python38/python.exe /c/Python38/python3.exe
      env:
        - PATH=/c/Python38:/c/Python38/Scripts:$PATH

    # deploy a source distribution
    - name: Deploy a source distribution
      stage: build
      dist: bionic
      script: python3 setup.py sdist --formats=gztar
      after_success: |
        if [[ ! -z $TRAVIS_TAG ]]; then
          python3 -m twine upload --skip-existing dist/*.tar.gz
        fi

    # deploy on linux
    - name: Build wheels on Linux
      stage: build
      dist: bionic
      services: docker
      script: python3 -m cibuildwheel --output-dir wheelhouse
      after_success: |
        if [[ ! -z $TRAVIS_TAG ]]; then
          python3 -m twine upload --skip-existing wheelhouse/*.whl
        fi
      env:
        - CIBW_BUILD=cp27-manylinux_x86_64 cp35-manylinux_x86_64 cp36-manylinux_x86_64 cp37-manylinux_x86_64 cp38-manylinux_x86_64
        - CIBW_MANYLINUX_X86_64_IMAGE=quay.io/pypa/manylinux2010_x86_64

    # deploy on mac
    - name: Build wheels on Mac
      stage: build
      os: mac
      osx_image: xcode12
      language: shell
      before_install: brew install libomp
      script: python3 -m cibuildwheel --output-dir wheelhouse
      after_success: |
        if [[ ! -z $TRAVIS_TAG ]]; then
          python3 -m twine upload --skip-existing wheelhouse/*.whl
        fi
      env:
        - CIBW_BUILD=cp27-macosx_x86_64 cp35-macosx_x86_64 cp36-macosx_x86_64 cp37-macosx_x86_64 cp38-macosx_x86_64

    # deploy on windows
    - name: Build wheels on Windows
      stage: build
      os: windows
      language: shell
      before_install: choco install python --version 3.8.0
      script: python -m cibuildwheel --output-dir wheelhouse
      after_success: |
        if [[ ! -z $TRAVIS_TAG ]]; then
          python3 -m twine upload --skip-existing wheelhouse/*.whl
        fi
      env:
        - PATH=/c/Python38:/c/Python38/Scripts:$PATH
        - CIBW_BUILD=cp35-win_amd64 cp36-win_amd64 cp37-win_amd64 cp38-win_amd64

env:
  global:
    - TWINE_USERNAME=__token__
    - CIBW_BEFORE_BUILD=pip3 install --upgrade numpy pytest
    - CIBW_TEST_COMMAND=pytest {project}
